<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | CopierMaster</title>
    <link rel="stylesheet" href="css/styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <aside class="sidebar">
        <div class="sidebar-brand"><img src="assets/logo.png" alt="CM"></div>
        <ul class="sidebar-menu">
            <li class="menu-item active" onclick="location.href='dashboard.html'"><i class="fas fa-chart-pie"></i> Dashboard</li>
            <li class="menu-item" onclick="location.href='tickets.html'"><i class="fas fa-ticket-alt"></i> Help Desk</li>
            <li class="menu-item" onclick="location.href='institutions.html'"><i class="fas fa-building"></i> Clientes</li>
            <li class="menu-item" onclick="location.href='equipment.html'"><i class="fas fa-print"></i> Equipos</li>
            <li class="menu-item" onclick="location.href='technicians.html'"><i class="fas fa-users-cog"></i> T√©cnicos</li>
            <li class="menu-item" onclick="location.href='reports.html'"><i class="fas fa-file-invoice-dollar"></i> Reportes</li>
        </ul>
    </aside>

    <main class="main-content">
        <header class="top-bar">
            <div class="page-title">Visi√≥n General</div>
            <div style="display:flex; align-items:center; gap:15px;">
                <div class="user-badge" onclick="openProfileModal()" style="cursor:pointer; display:flex; align-items:center; gap:10px;">
                    <span id="userName">Cargando...</span>
                    <i class="fas fa-user-circle" style="font-size:20px;"></i>
                </div>
                <button class="btn-logout" id="logoutBtn" title="Cerrar Sesi√≥n"><i class="fas fa-power-off"></i></button>
            </div>
        </header>

        <div class="scroll-area">
            <div class="kpi-grid">
                <div class="card">
                    <div class="kpi-title">Tickets Abiertos</div>
                    <div class="kpi-value" id="openTickets">--</div>
                </div>
                <div class="card">
                    <div class="kpi-title">En Proceso</div>
                    <div class="kpi-value" id="inProgress" style="color:#f59e0b;">--</div>
                </div>
                <div class="card">
                    <div class="kpi-title">Clientes</div>
                    <div class="kpi-value" id="institutions">--</div>
                </div>
                <div class="card">
                    <div class="kpi-title">Equipos</div>
                    <div class="kpi-value" id="equipment">--</div>
                </div>
            </div>

            <h3 style="color:var(--text-main); margin-top:40px;">‚ö° Gesti√≥n R√°pida</h3>
            <div class="actions-grid">
                <div class="action-btn" onclick="location.href='tickets.html'">
                    <i class="fas fa-file-medical" style="color:#ea580c;"></i>
                    <span>Crear Ticket</span>
                </div>
                <div class="action-btn" onclick="location.href='institutions.html'">
                    <i class="fas fa-plus-circle" style="color:#16a34a;"></i>
                    <span>Nuevo Cliente</span>
                </div>
                <div class="action-btn" onclick="location.href='technicians.html'">
                    <i class="fas fa-user-shield" style="color:#9333ea;"></i>
                    <span>Registrar T√©cnico</span>
                </div>
            </div>
        </div>
    </main>

    <div id="profileModal" class="modal-overlay">
        <div class="modal-box">
            <h3 class="modal-title">üîê Seguridad de la Cuenta</h3>
            <p style="color:#64748b; font-size:14px;">Actualiza tu contrase√±a de acceso.</p>
            
            <form id="passForm">
                <label>Nueva Contrase√±a</label>
                <input type="password" id="newPass" placeholder="M√≠nimo 6 caracteres" required>
                
                <label>Confirmar Contrase√±a</label>
                <input type="password" id="confPass" placeholder="Repite la contrase√±a" required>

                <div class="modal-actions">
                    <button type="button" class="btn-cancel" onclick="document.getElementById('profileModal').style.display='none'">Cancelar</button>
                    <button type="submit" class="btn-confirm">Actualizar Clave</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/security.js"></script>
    <script src="js/dashboard.js"></script>
    
    <script>
        window.openProfileModal = () => {
            document.getElementById('profileModal').style.display = 'flex';
        }

        document.getElementById('passForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const p1 = document.getElementById('newPass').value;
            const p2 = document.getElementById('confPass').value;
            const btn = e.target.querySelector('.btn-confirm');

            if (p1.length < 6) return alert("La contrase√±a debe tener al menos 6 caracteres.");
            if (p1 !== p2) return alert("Las contrase√±as no coinciden.");

            btn.innerHTML = "Guardando..."; btn.disabled = true;

            // Actualizar en Supabase Auth
            const { error } = await sb.auth.updateUser({ password: p1 });

            if (error) {
                alert("Error: " + error.message);
                btn.innerHTML = "Actualizar Clave"; btn.disabled = false;
            } else {
                alert("‚úÖ Contrase√±a actualizada correctamente.");
                document.getElementById('profileModal').style.display = 'none';
                e.target.reset();
                btn.innerHTML = "Actualizar Clave"; btn.disabled = false;
            }
        });
    </script>
</body>
</html>
