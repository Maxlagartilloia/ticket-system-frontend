<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clientes | CopierMaster</title>
    <link rel="stylesheet" href="css/styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .dept-list { list-style: none; padding: 0; margin: 0; max-height: 200px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px; }
        .dept-item { padding: 10px 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background: #fff; }
        .dept-item:last-child { border-bottom: none; }
        .btn-mini-del { color: #ef4444; cursor: pointer; border: none; background: none; font-size: 14px; }
    </style>
</head>
<body>
    <aside class="sidebar">
        <div class="sidebar-brand"><img src="assets/logo.png" alt="CM"></div>
        <ul class="sidebar-menu">
            <li class="menu-item" onclick="location.href='dashboard.html'"><i class="fas fa-chart-pie"></i> Dashboard</li>
            <li class="menu-item" onclick="location.href='tickets.html'"><i class="fas fa-ticket-alt"></i> Help Desk</li>
            <li class="menu-item active" onclick="location.href='institutions.html'"><i class="fas fa-building"></i> Clientes</li>
            <li class="menu-item" onclick="location.href='equipment.html'"><i class="fas fa-print"></i> Equipos</li>
            <li class="menu-item" onclick="location.href='technicians.html'"><i class="fas fa-users-cog"></i> T√©cnicos</li>
            <li class="menu-item" onclick="location.href='reports.html'"><i class="fas fa-file-invoice-dollar"></i> Reportes</li>
        </ul>
    </aside>

    <main class="main-content">
        <header class="top-bar">
            <div class="page-title">Cartera de Clientes</div>
            <button class="btn-logout" onclick="location.href='index.html'">Salir</button>
        </header>

        <div class="scroll-area">
            <div class="card">
                <h3 style="margin-top:0; color:var(--text-main);"><i class="fas fa-plus-circle"></i> Nuevo Cliente</h3>
                <form id="instForm">
                    <div class="actions-grid" style="grid-template-columns: 1fr 1fr 1fr auto;">
                        <input id="name" type="text" placeholder="Nombre Comercial" required style="margin-bottom:0;">
                        <input id="phone" type="text" placeholder="Tel√©fono" style="margin-bottom:0;">
                        <input id="address" type="text" placeholder="Direcci√≥n" style="margin-bottom:0;">
                        <button type="submit" class="btn" style="background:var(--sidebar-active); color:white; height:100%;">Guardar</button>
                    </div>
                </form>
            </div>

            <div class="card">
                <div style="display:flex; justify-content:space-between; margin-bottom:15px; align-items:center;">
                    <h3 style="margin:0;">Empresas Registradas</h3>
                    <button onclick="window.open('register.html', '_blank')" class="btn" style="width:auto; background:#16a34a; color:white; font-size:13px; padding: 8px 15px;">
                        <i class="fas fa-key"></i> Crear Accesos
                    </button>
                </div>
                <div style="overflow-x:auto;">
                    <table style="width:100%;">
                        <thead>
                            <tr>
                                <th style="width:50px;">ID</th>
                                <th>Empresa</th>
                                <th>Contacto</th>
                                <th>Estructura Organizacional</th>
                                <th style="text-align:center;">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="instTable">
                            <tr><td colspan="5" style="text-align:center; padding:20px;">Cargando...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <div id="deptModal" class="modal-overlay">
        <div class="modal-box">
            <h3 class="modal-title">Estructura: <span id="modalInstName">...</span></h3>
            <div style="display:flex; gap:10px; margin-bottom:20px; background:#f1f5f9; padding:15px; border-radius:8px;">
                <input id="newDeptName" type="text" placeholder="Nombre del √Årea" style="margin:0; background:white;">
                <button onclick="addDepartment()" class="btn" style="width:auto; background:#0f172a; color:white;"><i class="fas fa-plus"></i></button>
            </div>
            <ul id="deptList" class="dept-list"></ul>
            <div style="margin-top:20px; text-align:right;">
                <button class="btn-cancel" onclick="closeDeptModal()">Cerrar</button>
            </div>
        </div>
    </div>

    <div id="usersModal" class="modal-overlay">
        <div class="modal-box">
            <h3 class="modal-title">Usuarios de <span id="modalUserInstName">...</span></h3>
            <div id="usersList" style="margin-bottom:20px;">Cargando...</div>
            <button class="btn-cancel" onclick="document.getElementById('usersModal').style.display='none'">Cerrar</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/security.js"></script>
    <script>
        const sb = supabase.createClient('https://esxojlfcjwtahkcrqxkd.supabase.co', 'sb_publishable_j0IUHsFoKc8IK7tZbYwEGw_bN4bOD_y');
        let currentInstId = null;

        async function loadInstitutions() {
            const { data: insts } = await sb.from('institutions').select('*').order('id', {ascending:false});
            const { data: depts } = await sb.from('departments').select('institution_id');
            const deptCounts = {};
            depts?.forEach(d => deptCounts[d.institution_id] = (deptCounts[d.institution_id] || 0) + 1);

            const tb = document.getElementById('instTable');
            tb.innerHTML = '';
            if(!insts || !insts.length) { tb.innerHTML = '<tr><td colspan="5" style="text-align:center;">Sin datos</td></tr>'; return; }

            insts.forEach(i => {
                tb.innerHTML += `<tr>
                    <td><b>${i.id}</b></td>
                    <td style="font-weight:600;">${i.name}</td>
                    <td>${i.phone || '-'}</td>
                    <td><button onclick="openDeptModal(${i.id}, '${i.name}')" class="btn" style="width:auto; background:#e0f2fe; color:#0369a1; padding:6px 12px; font-size:12px;">Administrar √Åreas (${deptCounts[i.id] || 0})</button></td>
                    <td style="text-align:center;">
                        <button onclick="viewUsers(${i.id}, '${i.name}')" style="cursor:pointer; border:none; background:none;"><i class="fas fa-users"></i></button>
                        <button onclick="delInst(${i.id})" style="cursor:pointer; border:none; background:none; color:red; margin-left:10px;"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`;
            });
        }

        document.getElementById('instForm').addEventListener('submit', async(e) => {
            e.preventDefault();
            await sb.from('institutions').insert([{ name: document.getElementById('name').value, phone: document.getElementById('phone').value, address: document.getElementById('address').value }]);
            e.target.reset(); loadInstitutions();
        });

        window.openDeptModal = async (id, name) => {
            currentInstId = id; document.getElementById('modalInstName').innerText = name;
            document.getElementById('deptModal').style.display = 'flex'; loadDepartmentsInternal(id);
        }
        window.closeDeptModal = () => { document.getElementById('deptModal').style.display = 'none'; loadInstitutions(); }

        async function loadDepartmentsInternal(instId) {
            const list = document.getElementById('deptList'); list.innerHTML = '<li>Cargando...</li>';
            const { data } = await sb.from('departments').select('*').eq('institution_id', instId).order('name');
            list.innerHTML = '';
            if(!data.length) list.innerHTML = '<li style="padding:15px; text-align:center; color:#ccc;">Sin √°reas</li>';
            data.forEach(d => { list.innerHTML += `<li class="dept-item"><span>${d.name}</span> <button onclick="deleteDept(${d.id})" class="btn-mini-del"><i class="fas fa-times"></i></button></li>`; });
        }

        window.addDepartment = async () => {
            const val = document.getElementById('newDeptName').value.trim();
            if(!val) return;
            await sb.from('departments').insert([{ name: val, institution_id: currentInstId }]);
            document.getElementById('newDeptName').value = ''; loadDepartmentsInternal(currentInstId);
        }

        window.deleteDept = async (id) => { if(confirm('¬øBorrar?')) { await sb.from('departments').delete().eq('id', id); loadDepartmentsInternal(currentInstId); } }
        
        window.viewUsers = async (id, name) => {
            document.getElementById('modalUserInstName').innerText = name; document.getElementById('usersModal').style.display = 'flex';
            const list = document.getElementById('usersList'); list.innerHTML = '...';
            const { data } = await sb.from('profiles').select('email').eq('institution_id', id);
            list.innerHTML = data.length ? data.map(u => `<div>üë§ ${u.email}</div>`).join('') : 'Sin usuarios';
        }

        window.delInst = async(id) => { if(confirm('¬øEliminar?')) { await sb.from('institutions').delete().eq('id',id); loadInstitutions(); } };
        document.addEventListener("DOMContentLoaded", loadInstitutions);
    </script>
</body>
</html>
