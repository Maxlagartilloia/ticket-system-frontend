<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8"><title>Clientes | CopierMaster</title>
    <link rel="stylesheet" href="css/styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Estilo para la lista de departamentos dentro del modal */
        .dept-list { list-style: none; padding: 0; margin: 0; max-height: 200px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px; }
        .dept-item { padding: 10px 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background: #fff; }
        .dept-item:last-child { border-bottom: none; }
        .dept-item:nth-child(even) { background: #f8fafc; }
        .btn-mini-del { color: #ef4444; cursor: pointer; border: none; background: none; font-size: 14px; }
    </style>
</head>
<body>
    <aside class="sidebar">
        <div class="sidebar-brand"><img src="assets/logo.png" alt="CM"></div>
        <ul class="sidebar-menu">
            <li class="menu-item" onclick="location.href='dashboard.html'"><i class="fas fa-chart-pie"></i> Dashboard</li>
            <li class="menu-item" onclick="location.href='tickets.html'"><i class="fas fa-ticket-alt"></i> Help Desk</li>
            <li class="menu-item active" onclick="location.href='institutions.html'"><i class="fas fa-building"></i> Clientes</li>
            <li class="menu-item" onclick="location.href='equipment.html'"><i class="fas fa-print"></i> Equipos</li>
            <li class="menu-item" onclick="location.href='technicians.html'"><i class="fas fa-users-cog"></i> T√©cnicos</li>
            <li class="menu-item" onclick="location.href='reports.html'"><i class="fas fa-file-invoice-dollar"></i> Reportes</li>
        </ul>
    </aside>

    <main class="main-content">
        <header class="top-bar">
            <div class="page-title">Cartera de Clientes</div>
            <button class="btn-logout" onclick="location.href='index.html'">Salir</button>
        </header>

        <div class="scroll-area">
            
            <div class="card">
                <h3 style="margin-top:0; color:var(--text-main);"><i class="fas fa-plus-circle"></i> Nuevo Cliente</h3>
                <form id="instForm">
                    <div class="actions-grid" style="grid-template-columns: 1fr 1fr 1fr auto;">
                        <input id="name" type="text" placeholder="Nombre Comercial (Ej: GAD MUNICIPAL QUININDE)" required style="margin-bottom:0;">
                        <input id="phone" type="text" placeholder="Tel√©fono" style="margin-bottom:0;">
                        <input id="address" type="text" placeholder="Direcci√≥n" style="margin-bottom:0;">
                        <button type="submit" class="btn" style="background:var(--sidebar-active); color:white; height: 100%;">Guardar</button>
                    </div>
                </form>
            </div>

            <div class="card">
                <div style="display:flex; justify-content:space-between; margin-bottom:15px; align-items:center;">
                    <h3 style="margin:0;">Empresas Registradas</h3>
                    <button onclick="window.open('register.html', '_blank')" class="btn" style="width:auto; background:#16a34a; color:white; font-size:13px; padding: 8px 15px;">
                        <i class="fas fa-key"></i> Crear Accesos
                    </button>
                </div>

                <div style="overflow-x:auto;">
                    <table style="width:100%;">
                        <thead>
                            <tr>
                                <th style="width:50px;">ID</th>
                                <th>Empresa</th>
                                <th>Contacto</th>
                                <th>Estructura Organizacional</th> <th style="text-align:center;">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="instTable">
                            <tr><td colspan="5" style="text-align:center; padding:20px;">Cargando...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <div id="deptModal" class="modal-overlay">
        <div class="modal-box">
            <h3 class="modal-title" style="border-bottom:none; margin-bottom:10px;">
                Estructura: <span id="modalInstName" style="color:var(--sidebar-active);">...</span>
            </h3>
            <p style="color:#64748b; font-size:13px; margin-top:0;">Agrega las √°reas de este cliente (Ej: Financiero, Jur√≠dico).</p>

            <div style="display:flex; gap:10px; margin-bottom:20px; background:#f1f5f9; padding:15px; border-radius:8px;">
                <input id="newDeptName" type="text" placeholder="Nombre del √Årea (Ej: RRHH)" style="margin:0; background:white;">
                <button onclick="addDepartment()" class="btn" style="width:auto; background:#0f172a; color:white;"><i class="fas fa-plus"></i></button>
            </div>

            <label style="font-size:12px; text-transform:uppercase; font-weight:bold; color:#94a3b8;">√Åreas Existentes:</label>
            <ul id="deptList" class="dept-list">
                </ul>

            <div style="margin-top:20px; text-align:right;">
                <button class="btn-cancel" onclick="closeDeptModal()" style="width:auto; padding:10px 20px;">Cerrar</button>
            </div>
        </div>
    </div>

    <div id="usersModal" class="modal-overlay">
        <div class="modal-box">
            <h3 class="modal-title">Usuarios de <span id="modalUserInstName">...</span></h3>
            <div id="usersList" style="margin-bottom:20px;">Cargando...</div>
            <button class="btn-cancel" onclick="document.getElementById('usersModal').style.display='none'">Cerrar</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const sb = supabase.createClient('https://esxojlfcjwtahkcrqxkd.supabase.co', 'sb_publishable_j0IUHsFoKc8IK7tZbYwEGw_bN4bOD_y');
        let currentInstId = null; // ID del cliente que estamos editando

        // 1. CARGAR CLIENTES
        async function loadInstitutions() {
            const { data: insts } = await sb.from('institutions').select('*').order('id', {ascending:false});
            
            // Traer conteo de departamentos por cliente (para mostrar en la tabla)
            const { data: depts } = await sb.from('departments').select('institution_id');
            const deptCounts = {};
            depts?.forEach(d => deptCounts[d.institution_id] = (deptCounts[d.institution_id] || 0) + 1);

            const tb = document.getElementById('instTable');
            tb.innerHTML = '';

            if(!insts || insts.length === 0) {
                tb.innerHTML = '<tr><td colspan="5" style="text-align:center;">No hay clientes registrados.</td></tr>';
                return;
            }

            insts.forEach(i => {
                const count = deptCounts[i.id] || 0;
                tb.innerHTML += `
                    <tr>
                        <td><b>${i.id}</b></td>
                        <td style="font-weight:600; color:#1e293b;">${i.name}</td>
                        <td style="font-size:13px; color:#64748b;">${i.phone || '-'}</td>
                        <td>
                            <button onclick="openDeptModal(${i.id}, '${i.name}')" class="btn" style="width:auto; background:#e0f2fe; color:#0369a1; border:1px solid #bae6fd; font-size:12px; padding:6px 12px;">
                                <i class="fas fa-sitemap"></i> Administrar √Åreas (${count})
                            </button>
                        </td>
                        <td style="text-align:center;">
                            <button onclick="viewUsers(${i.id}, '${i.name}')" title="Ver Usuarios" style="cursor:pointer; border:none; background:none; color:#64748b;"><i class="fas fa-users"></i></button>
                            <button onclick="delInst(${i.id})" title="Eliminar" style="cursor:pointer; border:none; background:none; color:#ef4444; margin-left:10px;"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`;
            });
        }

        // 2. CREAR CLIENTE
        document.getElementById('instForm').addEventListener('submit', async(e) => {
            e.preventDefault();
            const name = document.getElementById('name').value;
            const phone = document.getElementById('phone').value;
            const address = document.getElementById('address').value;

            const { error } = await sb.from('institutions').insert([{ name, phone, address }]);
            if(error) alert("Error: " + error.message);
            else { e.target.reset(); loadInstitutions(); }
        });

        // 3. GESTI√ìN DE DEPARTAMENTOS (MODAL)
        window.openDeptModal = async (id, name) => {
            currentInstId = id;
            document.getElementById('modalInstName').innerText = name;
            document.getElementById('deptModal').style.display = 'flex';
            loadDepartmentsInternal(id);
        }

        window.closeDeptModal = () => {
            document.getElementById('deptModal').style.display = 'none';
            loadInstitutions(); // Recargar tabla principal para actualizar contador
        }

        async function loadDepartmentsInternal(instId) {
            const list = document.getElementById('deptList');
            list.innerHTML = '<li style="padding:10px; color:#94a3b8;">Cargando √°reas...</li>';

            const { data } = await sb.from('departments').select('*').eq('institution_id', instId).order('name');
            list.innerHTML = '';

            if(!data || data.length === 0) {
                list.innerHTML = '<li style="padding:15px; text-align:center; color:#cbd5e1; font-style:italic;">No hay departamentos creados a√∫n.</li>';
                return;
            }

            data.forEach(d => {
                list.innerHTML += `
                    <li class="dept-item">
                        <span style="font-weight:500; color:#334155;">${d.name}</span>
                        <button onclick="deleteDept(${d.id})" class="btn-mini-del" title="Eliminar √Årea"><i class="fas fa-times"></i></button>
                    </li>`;
            });
        }

        window.addDepartment = async () => {
            const input = document.getElementById('newDeptName');
            const name = input.value.trim();
            if(!name) return;

            const { error } = await sb.from('departments').insert([{ 
                name: name, 
                institution_id: currentInstId 
            }]);

            if(error) alert("Error: " + error.message);
            else {
                input.value = '';
                loadDepartmentsInternal(currentInstId); // Recargar solo la lista del modal
            }
        }

        window.deleteDept = async (deptId) => {
            if(!confirm("¬øBorrar esta √°rea? (Cuidado si tiene equipos asignados)")) return;
            await sb.from('departments').delete().eq('id', deptId);
            loadDepartmentsInternal(currentInstId);
        }

        // 4. OTROS (Usuarios y Borrar Cliente)
        window.viewUsers = async (instId, instName) => {
            document.getElementById('modalUserInstName').innerText = instName;
            document.getElementById('usersModal').style.display = 'flex';
            const list = document.getElementById('usersList');
            list.innerHTML = 'Buscando...';
            
            const { data } = await sb.from('profiles').select('email').eq('institution_id', instId);
            list.innerHTML = data.length ? data.map(u => `<div style="padding:5px; border-bottom:1px solid #eee;">üë§ ${u.email}</div>`).join('') : 'Sin usuarios.';
        }

        window.delInst = async(id) => { 
            if(confirm('¬øEliminar empresa por completo?')) { 
                await sb.from('institutions').delete().eq('id',id); 
                loadInstitutions(); 
            }
        };

        document.addEventListener("DOMContentLoaded", loadInstitutions);
    </script>
</body>
</html>
