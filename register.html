<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Alta de Usuarios | CopierMaster</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        body { background: #f8fafc; display: flex; justify-content: center; align-items: center; height: 100vh; }
        .register-box { background: white; width: 450px; padding: 40px; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; }
        .title { font-size: 20px; font-weight: 800; color: #0f172a; margin-bottom: 5px; }
        .subtitle { font-size: 14px; color: #64748b; margin-bottom: 25px; }
    </style>
</head>
<body>

    <div class="register-box">
        <div class="title"> Generar Credenciales</div>
        <div class="subtitle">Crear acceso seguro para un Cliente</div>

        <form id="regForm">
            <label>Empresa a la que pertenece</label>
            <select id="instSelect" required style="background:#f0f9ff; border-color:#bae6fd;">
                <option value="">Cargando empresas...</option>
            </select>

            <hr style="border:0; border-top:1px solid #eee; margin:20px 0;">

            <label>Correo Electr贸nico (Usuario)</label>
            <input type="email" id="email" placeholder="cliente@empresa.com" required>

            <label>Contrase帽a Temporal</label>
            <input type="text" id="password" placeholder="Ej: Copier2026" required>

            <label>Nombre del Encargado</label>
            <input type="text" id="fullname" placeholder="Ej: Dra. Maria Perez" required>

            <button type="submit" class="btn" style="background:#0f172a; color:white; margin-top:10px;">Crear y Vincular Usuario</button>
        </form>
        
        <div id="msg" style="margin-top:20px; font-size:13px; text-align:center;"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const sb = supabase.createClient('https://esxojlfcjwtahkcrqxkd.supabase.co', 'sb_publishable_j0IUHsFoKc8IK7tZbYwEGw_bN4bOD_y');

        // Cargar empresas al abrir
        async function loadInst() {
            const { data } = await sb.from('institutions').select('id, name').order('name');
            const sel = document.getElementById('instSelect');
            sel.innerHTML = '<option value="">-- Seleccione Empresa --</option>';
            data?.forEach(i => sel.innerHTML += `<option value="${i.id}">${i.name} (ID: ${i.id})</option>`);
        }
        loadInst();

        // Proceso de Registro
        document.getElementById('regForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            const msg = document.getElementById('msg');
            
            btn.innerHTML = "Creando..."; btn.disabled = true;
            msg.innerHTML = "";

            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const name = document.getElementById('fullname').value;
            const instId = document.getElementById('instSelect').value;

            // 1. Crear Usuario en Auth
            const { data, error } = await sb.auth.signUp({
                email: email,
                password: password,
                options: {
                    data: { full_name: name } // Guardar nombre en metadata
                }
            });

            if (error) {
                msg.innerHTML = `<span style="color:red;">Error: ${error.message}</span>`;
                btn.innerHTML = "Intentar de nuevo"; btn.disabled = false;
                return;
            }

            // 2. Vincular el perfil a la empresa (Actualizar tabla profiles)
            // Nota: El usuario se crea, pero necesitamos asignarle el ID de empresa inmediatamente.
            // Como estamos "deslogueados" o somos el usuario nuevo, aprovechamos su propia sesi贸n para actualizarse.
            
            if (data.user) {
                // Peque帽o delay para asegurar que el trigger de base de datos cre贸 el perfil
                setTimeout(async () => {
                    const { error: updateError } = await sb.from('profiles')
                        .update({ 
                            institution_id: instId,
                            full_name: name,
                            role: 'client' // Asegurar rol cliente
                        })
                        .eq('id', data.user.id);

                    if (updateError) {
                        console.error(updateError);
                        msg.innerHTML = `<span style="color:orange;">Usuario creado, pero hubo error vinculando empresa. Revisar manualmente.</span>`;
                    } else {
                        msg.innerHTML = `<div style="background:#dcfce7; color:#166534; padding:10px; border-radius:8px;">
                            <strong>隆xito!</strong><br>
                            Usuario: ${email}<br>
                            Clave: ${password}<br>
                            Empresa ID: ${instId}<br>
                            <br>Ya puedes entregar estas credenciales.
                        </div>`;
                        e.target.reset();
                    }
                    btn.innerHTML = "Crear Otro Usuario"; btn.disabled = false;
                    
                    // IMPORTANTE: Cerrar la sesi贸n del nuevo usuario para no quedarnos logueados como 茅l
                    await sb.auth.signOut();
                    
                }, 1000);
            }
        });
    </script>
</body>
</html>
