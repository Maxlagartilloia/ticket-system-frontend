<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Usuarios | CopierMaster</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        body { display: flex; align-items: center; justify-content: center; min-height: 100vh; background-color: #f1f5f9; }
        .register-container { background: white; width: 100%; max-width: 500px; padding: 30px; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; margin: 20px; }
    </style>
</head>
<body>

    <div class="register-container">
        <h2 style="margin-top:0; color:#0f172a;">üîê Crear Credenciales</h2>
        <p style="color:#64748b; margin-bottom:25px; font-size: 14px;">Genera accesos para clientes o personal t√©cnico.</p>

        <form id="regForm">
            <label>1. Tipo de Usuario</label>
            <select id="roleSelect" onchange="toggleInst(this.value)" required style="background:#f0f9ff; border-color:#bae6fd; font-weight:bold;">
                <option value="client">Cliente (Requiere Empresa)</option>
                <option value="technician">T√©cnico (Staff)</option>
                <option value="supervisor">Supervisor (Admin)</option>
            </select>

            <div id="instContainer">
                <label>2. Empresa del Cliente</label>
                <select id="instSelect">
                    <option value="">Cargando empresas...</option>
                </select>
            </div>

            <hr style="border:0; border-top:1px solid #eee; margin:20px 0;">

            <label>Correo Electr√≥nico</label>
            <input type="email" id="email" placeholder="ej: usuario@cliente.com" required>

            <label>Contrase√±a Temporal</label>
            <input type="text" id="password" placeholder="Ej: Clave2026" required>

            <label>Nombre Completo</label>
            <input type="text" id="fullname" placeholder="Ej: Dra. Ana Lopez" required>

            <button type="submit" class="btn" style="background:#0f172a; color:white; margin-top:10px;">Crear Usuario</button>
        </form>
        
        <div id="msg" style="margin-top:20px; font-size:13px; text-align:center;"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const sb = supabase.createClient('https://esxojlfcjwtahkcrqxkd.supabase.co', 'sb_publishable_j0IUHsFoKc8IK7tZbYwEGw_bN4bOD_y');

        window.toggleInst = (role) => {
            const div = document.getElementById('instContainer');
            const isClient = (role === 'client');
            div.style.display = isClient ? 'block' : 'none';
            document.getElementById('instSelect').required = isClient;
        }

        async function loadInst() {
            const { data } = await sb.from('institutions').select('id, name').order('name');
            const sel = document.getElementById('instSelect');
            sel.innerHTML = '<option value="">-- Seleccione Empresa --</option>';
            data?.forEach(i => sel.innerHTML += `<option value="${i.id}">${i.name}</option>`);
        }
        loadInst();

        document.getElementById('regForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            const msg = document.getElementById('msg');
            btn.innerHTML = "Procesando..."; btn.disabled = true; msg.innerHTML = "";

            const role = document.getElementById('roleSelect').value;
            const instId = role === 'client' ? document.getElementById('instSelect').value : null;
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const name = document.getElementById('fullname').value;

            // 1. Crear en Auth
            const { data, error } = await sb.auth.signUp({
                email: email, password: password,
                options: { data: { full_name: name } }
            });

            if (error) {
                msg.innerHTML = `<span style="color:red;">Error: ${error.message}</span>`;
                btn.innerHTML = "Intentar de nuevo"; btn.disabled = false;
                return;
            }

            // 2. Actualizar Perfil (Rol y Empresa)
            if (data.user) {
                // Esperamos un segundo para asegurar que el trigger de perfil se ejecute (si existe)
                // O hacemos upsert directo
                setTimeout(async () => {
                    const { error: profileError } = await sb.from('profiles').upsert({ 
                        id: data.user.id,
                        email: email, // Aseguramos email
                        institution_id: instId,
                        full_name: name,
                        role: role 
                    });
                    
                    if (profileError) {
                         msg.innerHTML = `<span style="color:orange;">Usuario creado, pero error en perfil: ${profileError.message}</span>`;
                    } else {
                        msg.innerHTML = `<div style="background:#dcfce7; color:#166534; padding:10px; border-radius:8px;">
                            <strong>¬°Usuario Creado!</strong><br>
                            Rol: ${role.toUpperCase()}<br>
                            Email: ${email}<br>
                            Clave: ${password}
                        </div>`;
                        e.target.reset();
                    }
                    
                    btn.innerHTML = "Crear Otro"; btn.disabled = false;
                    await sb.auth.signOut(); // Salir para no quedar logueado con el nuevo usuario
                }, 1000);
            }
        });
    </script>
</body>
</html>
